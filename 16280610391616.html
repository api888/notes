<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        烂笔头
    </title>
    <meta name="description" content="">
    <link href="atom.xml" rel="alternate" title="烂笔头" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>
        hljs.initHighlightingOnLoad();
    </script>

</head>

<body class="antialiased hide-extras"></body>

<div class="inner-wrap">


    <nav class="top-bar docs-bar hide-for-small" data-topbar>

        <div id="header">
            <h1><a href="index.html">烂笔头</a></h1>
        </div>

    </nav>


    <div class="row">
        <div class="sidebar">
            <ul id="side-nav" class="side-nav">

                
                <li class="side-title"><span>Android</span></li>
                
                <li><a title="Android登录页面，未勾选用户协议、隐私政策出现抖动效果" href="16280609822586.html">Android登录页面，未勾选用户协议、隐私政策出现抖动效果</a></li>
                
                <li><a title="DialogFragment内存泄露问题能不能一次性改好" href="16251021954820.html">DialogFragment内存泄露问题能不能一次性改好</a></li>
                
                <li><a title="Android静默安装实现方案，仿360手机助手秒装和智能安装功能" href="16251021954779.html">Android静默安装实现方案，仿360手机助手秒装和智能安装功能</a></li>
                
                <li><a title="Android 添加水印功能" href="16251021954737.html">Android 添加水印功能</a></li>
                
                <li><a title="Android 监听手电筒状态" href="16251021954689.html">Android 监听手电筒状态</a></li>
                 
                <li class="side-title"><span>Github</span></li>
                
                <li><a title="使用Github+jsdelivr构建你的免费图床" href="16251022060206.html">使用Github+jsdelivr构建你的免费图床</a></li>
                 
                <li class="side-title"><span>Glide</span></li>
                
                <li><a title="Glide源码修改-自定义磁盘缓存实现永久存储" href="16251022251608.html">Glide源码修改-自定义磁盘缓存实现永久存储</a></li>
                
                <li><a title="Android—Glide使用教程（一）" href="16251022251568.html">Android—Glide使用教程（一）</a></li>
                
                <li><a title="Android—Glide使用教程（二）" href="16251022251484.html">Android—Glide使用教程（二）</a></li>
                
                <li><a title="Android—Glide使用教程（三）" href="16251022251527.html">Android—Glide使用教程（三）</a></li>
                 
                <li class="side-title"><span>Gradle</span></li>
                
                <li><a title="Gradle 自定义Plugin插件之上传APK到蒲公英" href="16280610391708.html">Gradle 自定义Plugin插件之上传APK到蒲公英</a></li>
                
                <li><a title="自定义Gradle Plugin，优雅的解决第三方Jar包中的bug" href="16280610391664.html">自定义Gradle Plugin，优雅的解决第三方Jar包中的bug</a></li>
                
                <li><a title="如何使用Android Studio开发Gradle插件" href="16280610391616.html">如何使用Android Studio开发Gradle插件</a></li>
                
                <li><a title="sourceSets使用" href="16251022385733.html">sourceSets使用</a></li>
                
                <li><a title="脑洞大开，Gradle项目管理依赖的船新版本" href="16251022385689.html">脑洞大开，Gradle项目管理依赖的船新版本</a></li>
                 
                <li class="side-title"><span>Rxjava</span></li>
                
                <li><a title="RxJava2 只看这一篇文章就够了" href="16251022491138.html">RxJava2 只看这一篇文章就够了</a></li>
                 
                <li class="side-title"><span>GreenDAO</span></li>
                
                <li><a title="GreenDao 3.3.0 基本使用与入门 （一）" href="16280610693006.html">GreenDao 3.3.0 基本使用与入门 （一）</a></li>
                
                <li><a title="GreenDao 3.3.0 多表关联使用（二）" href="16280610765764.html">GreenDao 3.3.0 多表关联使用（二）</a></li>
                
                <li><a title="GreenDao 3.3.0 增删改查的使用（三）" href="16280610843145.html">GreenDao 3.3.0 增删改查的使用（三）</a></li>
                 
                <li class="side-title"><span>组件化</span></li>
                
                <li><a title="组件化架构之解决Common组件中心化问题(api化方案)" href="16280609309201.html">组件化架构之解决Common组件中心化问题(api化方案)</a></li>
                 
            </ul>
        </div>
        <div class="columns"> <div id="main-content" class="markdown-body">
    <h1>如何使用Android Studio开发Gradle插件</h1>

    <p><a href="https://blog.csdn.net/sbsujjbcy/article/details/50782830">原文</a></p>

<ul>
<li>
<a href="#toc_0">插件类型</a>
</li>
<li>
<a href="#toc_1">Gradle相关语法</a>
</li>
<li>
<a href="#toc_2">Gradle插件开发</a>
</li>
<li>
<a href="#toc_3">发布到本地仓库</a>
</li>
<li>
<a href="#toc_4">最佳实践</a>
</li>
<li>
<a href="#toc_5">传递参数</a>
</li>
</ul>


<h1 id="toc_0">插件类型</h1>

<p>Gradle的插件一般有这么几种：</p>

<ul>
<li>一种是直接在项目中的gradle文件里编写，这种方式的缺点是无法复用插件代码，在其他项目中还得复制一遍代码（或者说说复制一遍文件）</li>
<li>另一种是在独立的项目里编写插件，然后发布到中央仓库，之后直接引用就可以了，优点就是可复用。</li>
</ul>

<h1 id="toc_1">Gradle相关语法</h1>

<p>本篇文章不会详细说明Gradle相关的语法，如果要学习gradle相关的东西，请查看<a href="https://segmentfault.com/a/1190000004229002">Gradle for Android</a></p>

<h1 id="toc_2">Gradle插件开发</h1>

<p>Gradle插件是使用Groovy进行开发的，而Groovy其实是可以兼容Java的。Android Studio其实除了开发Android App外，完全可以胜任开发Gradle插件这一工作，下面来讲讲具体如何开发。</p>

<ol>
<li>首先，新建一个Android项目。</li>
<li>之后，新建一个Android Module项目，类型选择Android Library。</li>
<li>将新建的Module中除了build.gradle文件外的其余文件全都删除，然后删除build.gradle文件中的所有内容。</li>
<li>在新建的module中新建文件夹src，接着在src文件目录下新建main文件夹，在main目录下新建groovy目录，这时候groovy文件夹会被Android识别为groovy源码目录。除了在main目录下新建groovy目录外，你还要在main目录下新建resources目录，同理resources目录会被自动识别为资源文件夹。在groovy目录下新建项目包名，就像Java包名那样。resources目录下新建文件夹META-INF，META-INF文件夹下新建gradle-plugins文件夹。这样，就完成了gradle 插件的项目的整体搭建，之后就是小细节了。目前，项目的结构是这样的。</li>
</ol>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20160302210530915" alt=""/></p>

<p>打开Module下的build.gradle文件，输入</p>

<pre><code class="language-groovy">apply plugin: &#39;groovy&#39;
apply plugin: &#39;maven&#39;

dependencies {
    compile gradleApi()
    compile localGroovy()
}

repositories {
    mavenCentral()
}
</code></pre>

<p>下面我们在包名下新建一个文件，命名为PluginImpl.groovy，注意有groovy后缀，然后在里面输入，注意包名替换为你自己的包名。</p>

<pre><code class="language-groovy">package cn.edu.zafu.gradle

import org.gradle.api.Plugin
import org.gradle.api.Project

public class PluginImpl implements Plugin&lt;Project&gt; {
    void apply(Project project) {
       project.task(&#39;testTask&#39;) &lt;&lt; {
            println &quot;Hello gradle plugin&quot;
        }
    }
}
</code></pre>

<p>然后在resources/META-INF/gradle-plugins目录下新建一个properties文件，注意该文件的命名就是你只有使用插件的名字，这里命名为plugin.test.properties，在里面输入</p>

<pre><code class="language-properties">implementation-class=cn.edu.zafu.gradle.PluginImpl
</code></pre>

<p>注意包名需要替换为你自己的包名。</p>

<p>这样就完成了最简单的一个gradle插件，里面有一个叫testTask的Task，执行该task后会输出一段文字，就像当初我们输出HelloWorld一样。</p>

<h1 id="toc_3">发布到本地仓库</h1>

<p>接着，我们需要将插件发布到maven中央仓库，我们将插件发布到本地仓库就好了，在module项目下的buidl.gradle文件中加入发布的代码。</p>

<pre><code class="language-groovy">repositories {
    mavenCentral()
}
group=&#39;cn.edu.zafu.gradle.plugin&#39;
version=&#39;1.0.0&#39;

uploadArchives {
    repositories {
        mavenDeployer {
            repository(url: uri(&#39;../repo&#39;))
        }
    }
}
</code></pre>

<p>上面的group和version的定义会被使用，作为maven库的坐标的一部分，group会被作为坐标的groupId，version会被作为坐标的version，而坐标的artifactId组成即module名，我们让其取一个别名moduleName。然后maven本地仓库的目录就是当前项目目录下的repo目录。 <br/>
这时候，右侧的gradle Toolbar就会在module下多出一个task</p>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20160302212456848" alt=""/></p>

<p>点击uploadArchives这个Task，就会在项目下多出一个repo目录，里面存着这个gradle插件。</p>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20160302213048489" alt=""/></p>

<p>目录就像上图这样，具体目录结构和你的包名等一系列有关，time是我的module名。</p>

<p>发布到本地maven仓库后，我们就使用它，在叫app的android项目下的gradle.build的文件中加入</p>

<pre><code class="language-groovy">buildscript {
    repositories {
        maven {
            url uri(&#39;../repo&#39;)
        }
    }
    dependencies {
        classpath &#39;cn.edu.zafu.gradle.plugin:time:1.0.0&#39;
    }
}
apply plugin: &#39;plugin.test&#39;
</code></pre>

<p>apply plugin后面引号内的名字就是前文plugin.test.properties文件的文件名。而class path后面引号里的内容，就是上面grade中定义的group，version以及moduleName所共同决定的，和maven是一样的。</p>

<p>同步一下gradle，右侧app下other分类下就会多出一个testTask，双击执行这个Task，控制台就会输出刚才我们输入的字符串</p>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20160302213504741" alt=""/></p>

<h1 id="toc_4">最佳实践</h1>

<p>最佳实践的来源是源自multidex，为什么呢，因为最近当方法数超了之后，如果选择multidex，编译的过程就会慢很多很多，为了检测到底是哪一步的耗时，需要编写一个插件来统计各个task执行的时间，因此就有了这么一个最佳实践。</p>

<p>在PluginImpl同级目录下新建TimeListener.groovy文件。输入</p>

<pre><code class="language-groovy">package cn.edu.zafu.gradle

import org.gradle.BuildListener
import org.gradle.BuildResult
import org.gradle.api.Task
import org.gradle.api.execution.TaskExecutionListener
import org.gradle.api.initialization.Settings
import org.gradle.api.invocation.Gradle
import org.gradle.api.tasks.TaskState
import org.gradle.util.Clock

class TimeListener implements TaskExecutionListener, BuildListener {
    private Clock clock
    private times = []

    @Override
    void beforeExecute(Task task) {
        clock = new org.gradle.util.Clock()
    }

    @Override
    void afterExecute(Task task, TaskState taskState) {
        def ms = clock.timeInMs
        times.add([ms, task.path])
        task.project.logger.warn &quot;${task.path} spend ${ms}ms&quot;
    }

    @Override
    void buildFinished(BuildResult result) {
        println &quot;Task spend time:&quot;
        for (time in times) {
            if (time[0] &gt;= 50) {
                printf &quot;%7sms  %s\n&quot;, time
            }
        }
    }

    @Override
    void buildStarted(Gradle gradle) {}

    @Override
    void projectsEvaluated(Gradle gradle) {}

    @Override
    void projectsLoaded(Gradle gradle) {}

    @Override
    void settingsEvaluated(Settings settings) {}
}
</code></pre>

<p>然后将PluginImpl文件中的apply方法修改为</p>

<pre><code class="language-groovy">void apply(Project project) {
       project.gradle.addListener(new TimeListener())
    }
</code></pre>

<p>完成后打包发布到jcenter()。之后你只要引用了该插件，就会统计各个task执行的时间，比如运行app，就会输出像下面的信息。</p>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20160302220607925" alt=""/></p>

<h1 id="toc_5">传递参数</h1>

<p>上面的是小试牛刀了下，接下来我们需要获得自定义的参数。</p>

<p>首先按照上面的步骤新建一个module。新建PluginExtension.groovy，输入</p>

<pre><code class="language-groovy">public class PluginExtension {
    def param1 = &quot;param1 defaut&quot;
    def param2 = &quot;param2 defaut&quot;
    def param3 = &quot;param3 defaut&quot;
}
</code></pre>

<p>然后我们希望能传入嵌套的参数，再新建一个PluginNestExtension.groovy，输入</p>

<pre><code class="language-groovy">public class PluginNestExtension {
    def nestParam1 = &quot;nestParam1 defaut&quot;
    def nestParam2 = &quot;nestParam2 defaut&quot;
    def nestParam3 = &quot;nestParam3 defaut&quot;
}
</code></pre>

<p>然后新建一个CustomTask.groovy，继承DefaultTask类，使用 @TaskAction注解标注实现的方法</p>

<pre><code class="language-groovy">public class CustomTask extends DefaultTask {

    @TaskAction
    void output() {
        println &quot;param1 is ${project.pluginExt.param1}&quot;
        println &quot;param2 is ${project.pluginExt.param2}&quot;
        println &quot;param3 is ${project.pluginExt.param3}&quot;
        println &quot;nestparam1 is ${project.pluginExt.nestExt.nestParam1}&quot;
        println &quot;nestparam2 is ${project.pluginExt.nestExt.nestParam2}&quot;
        println &quot;nestparam3 is ${project.pluginExt.nestExt.nestParam3}&quot;
    }
}
</code></pre>

<p>只是做了拿到了参数，然后做最简单的输出操作，使用 <code>${project.pluginExt.param1}</code>和 <code>${project.pluginExt.nestExt.nestParam1}</code>等拿到外部的参数。</p>

<p>别忘了在META-INF/gradle-plugins目录下新建properties文件指定插件的接口实现类。</p>

<p>复制之前新建的PluginImpl.groovy到包下，修改apply方法</p>

<pre><code class="language-groovy">public class PluginImpl implements Plugin&lt;Project&gt; {
    void apply(Project project) {
        project.extensions.create(&#39;pluginExt&#39;, PluginExtension)
        project.pluginExt.extensions.create(&#39;nestExt&#39;, PluginNestExtension)
        project.task(&#39;customTask&#39;, type: CustomTask)
    }
}
</code></pre>

<p>将插件发布到本地maven后，进行引用。</p>

<pre><code class="language-groovy">buildscript {
    repositories {
        maven {
            url uri(&#39;../repo&#39;)
        }
    }
    dependencies {
        classpath &#39;cn.edu.zafu.gradle.plugin:test:1.0.0&#39;
    }
}
apply plugin: &#39;plugin.test&#39;
</code></pre>

<p>定义外部参数，这里我们定义了param1,param2,nestParam1,nestParam2，此外param3和nestParam3保持默认。</p>

<pre><code class="language-groovy">pluginExt {
    param1 = &#39;app param1&#39;
    param2 = &#39;app param2&#39;
    nestExt{
        nestParam1=&#39;app nestParam1&#39;
        nestParam2=&#39;app nestParam2&#39;

    }
}
</code></pre>

<p>同步一下gradle，执行customTask。</p>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20160303111038118" alt=""/></p>


</div>

<br /><br />
<hr />

<div class="content-nav">
    <div class="large-6 columns">
        <div class="text-left" style="padding:15px 0px;">
            
            <a href="16280610391664.html" title="Previous Post: 自定义Gradle Plugin，优雅的解决第三方Jar包中的bug">&laquo; 自定义Gradle Plugin，优雅的解决第三方Jar包中的bug</a> 
        </div>
    </div>
    <div class="large-6 columns">
        <div class="text-right" style="padding:15px 0px;">
            
            <a href="16280609822586.html" title="Next Post: Android登录页面，未勾选用户协议、隐私政策出现抖动效果">Android登录页面，未勾选用户协议、隐私政策出现抖动效果 &raquo;</a> 
        </div>
    </div>
</div>

<div class="content_share">
    <div style="padding:0px 0.93em;" class="share-comments">
        
    </div>
</div>
<script type="text/javascript">
    $(function() {
        var currentURL = '16280610391616.html';
        $('#side-nav a').each(function() {
            if ($(this).attr('href') == currentURL) {
                $(this).parent().addClass('active');
            }
        });
    });
</script>  </div>
</div>


<div class="page-bottom">
    <div class="copyright">
        <a href="mailto:888api@sina.com">郝彬彬</a> &copy; 
    </div>
    <div class="copyright text-right">
        <a href="#main-content">TOP</a>
    </div>
</div>

</div>




  














<style type="text/css">
    figure {
        margin: 0.4em 0;
        padding: 0;
    }
    
    figcaption {
        text-align: center;
    }
    /* PrismJS 1.14.0
 http://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript */
    /**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */
    
    code[class*="language-"],
    pre[class*="language-"] {
        color: black;
        background: none;
        text-shadow: 0 1px white;
        font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        line-height: 1.5;
        -moz-tab-size: 4;
        -o-tab-size: 4;
        tab-size: 4;
        -webkit-hyphens: none;
        -moz-hyphens: none;
        -ms-hyphens: none;
        hyphens: none;
    }
    
    pre[class*="language-"]::-moz-selection,
    pre[class*="language-"] ::-moz-selection,
    code[class*="language-"]::-moz-selection,
    code[class*="language-"] ::-moz-selection {
        text-shadow: none;
        background: #b3d4fc;
    }
    
    pre[class*="language-"]::selection,
    pre[class*="language-"] ::selection,
    code[class*="language-"]::selection,
    code[class*="language-"] ::selection {
        text-shadow: none;
        background: #b3d4fc;
    }
    
    @media print {
        code[class*="language-"],
        pre[class*="language-"] {
            text-shadow: none;
        }
    }
    /* Code blocks */
    
    pre[class*="language-"] {
        padding: 1em;
        margin: .5em 0;
        overflow: auto;
    }
    
     :not(pre)>code[class*="language-"],
    pre[class*="language-"] {
        background: #F7F7F7;
    }
    /* Inline code */
    
     :not(pre)>code[class*="language-"] {
        padding: .1em;
        border-radius: .3em;
        white-space: normal;
    }
    
    .token.comment,
    .token.prolog,
    .token.doctype,
    .token.cdata {
        color: slategray;
    }
    
    .token.punctuation {
        color: #999;
    }
    
    .namespace {
        opacity: .7;
    }
    
    .token.property,
    .token.tag,
    .token.boolean,
    .token.number,
    .token.constant,
    .token.symbol,
    .token.deleted {
        color: #905;
    }
    
    .token.selector,
    .token.attr-name,
    .token.string,
    .token.char,
    .token.builtin,
    .token.inserted {
        color: #690;
    }
    
    .token.operator,
    .token.entity,
    .token.url,
    .language-css .token.string,
    .style .token.string {
        color: #9a6e3a;
        background: hsla(0, 0%, 100%, .5);
    }
    
    .token.atrule,
    .token.attr-value,
    .token.keyword {
        color: #07a;
    }
    
    .token.function,
    .token.class-name {
        color: #DD4A68;
    }
    
    .token.regex,
    .token.important,
    .token.variable {
        color: #e90;
    }
    
    .token.important,
    .token.bold {
        font-weight: bold;
    }
    
    .token.italic {
        font-style: italic;
    }
    
    .token.entity {
        cursor: help;
    }
    
    pre[class*="language-"].line-numbers {
        position: relative;
        padding-left: 3.8em;
        counter-reset: linenumber;
    }
    
    pre[class*="language-"].line-numbers>code {
        position: relative;
        white-space: inherit;
    }
    
    .line-numbers .line-numbers-rows {
        position: absolute;
        pointer-events: none;
        top: 0;
        font-size: 100%;
        left: -3.8em;
        width: 3em;
        /* works for line-numbers below 1000 lines */
        letter-spacing: -1px;
        border-right: 1px solid #999;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    .line-numbers-rows>span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
    }
    
    .line-numbers-rows>span:before {
        content: counter(linenumber);
        color: #999;
        display: block;
        padding-right: 0.8em;
        text-align: right;
    }
</style>

<script src="asset/js/foundation.min.js"></script>
<script src="asset/js/foundation/foundation.offcanvas.js"></script>
<script>
    $(document).foundation();
</script>
<script src="asset/js/watermark.js"></script>

</body>

</html>