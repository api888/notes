<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        烂笔头
    </title>
    <meta name="description" content="">
    <link href="atom.xml" rel="alternate" title="烂笔头" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>
        hljs.initHighlightingOnLoad();
    </script>

</head>

<body class="antialiased hide-extras"></body>

<div class="inner-wrap">


    <nav class="top-bar docs-bar hide-for-small" data-topbar>

        <div id="header">
            <h1><a href="index.html">烂笔头</a></h1>
        </div>

    </nav>


    <div class="row">
        <div class="sidebar">
            <ul id="side-nav" class="side-nav">

                
                <li class="side-title"><span>Android</span></li>
                
                <li><a title="Android登录页面，未勾选用户协议、隐私政策出现抖动效果" href="16280609822586.html">Android登录页面，未勾选用户协议、隐私政策出现抖动效果</a></li>
                
                <li><a title="DialogFragment内存泄露问题能不能一次性改好" href="16251021954820.html">DialogFragment内存泄露问题能不能一次性改好</a></li>
                
                <li><a title="Android静默安装实现方案，仿360手机助手秒装和智能安装功能" href="16251021954779.html">Android静默安装实现方案，仿360手机助手秒装和智能安装功能</a></li>
                
                <li><a title="Android 添加水印功能" href="16251021954737.html">Android 添加水印功能</a></li>
                
                <li><a title="Android 监听手电筒状态" href="16251021954689.html">Android 监听手电筒状态</a></li>
                 
                <li class="side-title"><span>Github</span></li>
                
                <li><a title="使用Github+jsdelivr构建你的免费图床" href="16251022060206.html">使用Github+jsdelivr构建你的免费图床</a></li>
                 
                <li class="side-title"><span>Glide</span></li>
                
                <li><a title="Glide源码修改-自定义磁盘缓存实现永久存储" href="16251022251608.html">Glide源码修改-自定义磁盘缓存实现永久存储</a></li>
                
                <li><a title="Android—Glide使用教程（一）" href="16251022251568.html">Android—Glide使用教程（一）</a></li>
                
                <li><a title="Android—Glide使用教程（二）" href="16251022251484.html">Android—Glide使用教程（二）</a></li>
                
                <li><a title="Android—Glide使用教程（三）" href="16251022251527.html">Android—Glide使用教程（三）</a></li>
                 
                <li class="side-title"><span>Gradle</span></li>
                
                <li><a title="Gradle 自定义Plugin插件之上传APK到蒲公英" href="16280610391708.html">Gradle 自定义Plugin插件之上传APK到蒲公英</a></li>
                
                <li><a title="自定义Gradle Plugin，优雅的解决第三方Jar包中的bug" href="16280610391664.html">自定义Gradle Plugin，优雅的解决第三方Jar包中的bug</a></li>
                
                <li><a title="如何使用Android Studio开发Gradle插件" href="16280610391616.html">如何使用Android Studio开发Gradle插件</a></li>
                
                <li><a title="sourceSets使用" href="16251022385733.html">sourceSets使用</a></li>
                
                <li><a title="脑洞大开，Gradle项目管理依赖的船新版本" href="16251022385689.html">脑洞大开，Gradle项目管理依赖的船新版本</a></li>
                 
                <li class="side-title"><span>Rxjava</span></li>
                
                <li><a title="RxJava2 只看这一篇文章就够了" href="16251022491138.html">RxJava2 只看这一篇文章就够了</a></li>
                 
                <li class="side-title"><span>GreenDAO</span></li>
                
                <li><a title="GreenDao 3.3.0 基本使用与入门 （一）" href="16280610693006.html">GreenDao 3.3.0 基本使用与入门 （一）</a></li>
                
                <li><a title="GreenDao 3.3.0 多表关联使用（二）" href="16280610765764.html">GreenDao 3.3.0 多表关联使用（二）</a></li>
                
                <li><a title="GreenDao 3.3.0 增删改查的使用（三）" href="16280610843145.html">GreenDao 3.3.0 增删改查的使用（三）</a></li>
                 
                <li class="side-title"><span>组件化</span></li>
                
                <li><a title="组件化架构之解决Common组件中心化问题(api化方案)" href="16280609309201.html">组件化架构之解决Common组件中心化问题(api化方案)</a></li>
                 
            </ul>
        </div>
        <div class="columns"> <div id="main-content" class="markdown-body">
    <h1>GreenDao 3.3.0 增删改查的使用（三）</h1>

    <ul>
<li>
<a href="#toc_0">GreenDao 的数据操作处理是继承自AbstractDao这个抽象类</a>
<ul>
<li>
<a href="#toc_1">最基本的函数：</a>
</li>
<li>
<a href="#toc_2">save 和 insertOrReplace 区别</a>
<ul>
<li>
<a href="#toc_3">save</a>
</li>
<li>
<a href="#toc_4">insertOrReplace</a>
</li>
</ul>
</li>
<li>
<a href="#toc_5">QueryBuilder 构建查询语</a>
</li>
<li>
<a href="#toc_6">Property 配置where 条件判断</a>
</li>
<li>
<a href="#toc_7">分页查询</a>
</li>
<li>
<a href="#toc_8">查询与LazyList类</a>
</li>
<li>
<a href="#toc_9">getDaoSession/getDatabase 开启事物处理</a>
<ul>
<li>
<a href="#toc_10">getDatabase 开启</a>
</li>
<li>
<a href="#toc_11">getDaoSession 开启</a>
</li>
<li>
<a href="#toc_12">callInTx 事物处理 执行查询操作</a>
</li>
<li>
<a href="#toc_13">getDaoSession runInTx 开启线程处理</a>
</li>
</ul>
</li>
<li>
<a href="#toc_14">insertOrReplace 新增或修改数据</a>
</li>
<li>
<a href="#toc_15">QueryBuilder 切换条件执行查询语句</a>
</li>
<li>
<a href="#toc_16">执行SQL语句</a>
<ul>
<li>
<a href="#toc_17">rawQuery queryRawCreate execSQL</a>
</li>
</ul>
</li>
<li>
<a href="#toc_18">QueryBuilder buildDelete 带事物删除</a>
</li>
<li>
<a href="#toc_19">Query SQL 查询</a>
</li>
<li>
<a href="#toc_20">自定义SQL 拼接多个查询语句</a>
</li>
</ul>
</li>
</ul>


<h1 id="toc_0">GreenDao 的数据操作处理是继承自AbstractDao这个抽象类</h1>

<h2 id="toc_1">最基本的函数：</h2>

<ul>
<li>insert(T) delete(T) update(T) save(T) insertOrReplace(T) loadAll()</li>
<li>其中 save(T) 和insertOrReplace(T) 方法比较特殊既能进行插入操作也能执行修改操作</li>
<li>insertInTx(T…) deleteInTx(T…) updateInTx(T…) saveInTx(T…) insertOrReplaceInTx(T…)</li>
<li>refresh(T) 刷新数据</li>
</ul>

<blockquote>
<p>注意：在这函数后面有InTx(T…),是表示开启事物进行多个数据的操作</p>
</blockquote>

<pre><code class="language-java">/**
     * Inserts the given entities in the database using a transaction.
     *
     * @param entities The entities to insert.
     */
    public void insertInTx(T... entities) {
        insertInTx(Arrays.asList(entities), isEntityUpdateable());
    }
    
       /**
     * Inserts the given entities in the database using a transaction. The given entities will become tracked if the PK
     * is set.
     *
     * @param entities      The entities to insert.
     * @param setPrimaryKey if true, the PKs of the given will be set after the insert; pass false to improve
     *                      performance.
     */
    public void insertInTx(Iterable&lt;T&gt; entities, boolean setPrimaryKey) {
        DatabaseStatement stmt = statements.getInsertStatement();
        executeInsertInTx(stmt, entities, setPrimaryKey);
    }
    
        private void executeInsertInTx(DatabaseStatement stmt, Iterable&lt;T&gt; entities, boolean setPrimaryKey) {
        db.beginTransaction();
        try {
            synchronized (stmt) {
                if (identityScope != null) {
                    identityScope.lock();
                }
                try {
                    if (isStandardSQLite) {
                        SQLiteStatement rawStmt = (SQLiteStatement) stmt.getRawStatement();
                        for (T entity : entities) {
                            bindValues(rawStmt, entity);
                            if (setPrimaryKey) {
                                long rowId = rawStmt.executeInsert();
                                updateKeyAfterInsertAndAttach(entity, rowId, false);
                            } else {
                                rawStmt.execute();
                            }
                        }
                    } else {
                        for (T entity : entities) {
                            bindValues(stmt, entity);
                            if (setPrimaryKey) {
                                long rowId = stmt.executeInsert();
                                updateKeyAfterInsertAndAttach(entity, rowId, false);
                            } else {
                                stmt.execute();
                            }
                        }
                    }
                } finally {
                    if (identityScope != null) {
                        identityScope.unlock();
                    }
                }
            }
            db.setTransactionSuccessful();
        } finally {
            db.endTransaction();
        }
    }
    
</code></pre>

<h2 id="toc_2">save 和 insertOrReplace 区别</h2>

<h3 id="toc_3">save</h3>

<blockquote>
<p>save it will be inserted (key is null) or updated (key is not null)<br/>
有key的对象执行更新，无key的执行插入<br/>
当对象有key但并不在数据库时会执行失败.适用于保存本地列表</p>
</blockquote>

<pre><code class="language-java">/**
     * &quot;Saves&quot; an entity to the database: depending on the existence of the key property, it will be inserted
     * (key is null) or updated (key is not null).
     * &lt;p&gt;
     * This is similar to {@link #insertOrReplace(Object)}, but may be more efficient, because if a key is present,
     * it does not have to query if that key already exists.
     */
    public void save(T entity) {
        if (hasKey(entity)) {
            update(entity);
        } else {
            insert(entity);
        }
    }
</code></pre>

<h3 id="toc_4">insertOrReplace</h3>

<blockquote>
<p>传入的对象在数据库中，有则更新无则插入,源码显示带有事物和线程<br/>
推荐同步数据库时使用该方法</p>
</blockquote>

<pre><code class="language-java"> /**
     * Insert an entity into the table associated with a concrete DAO.
     *
     * @return row ID of newly inserted entity
     */
    public long insertOrReplace(T entity) {
        return executeInsert(entity, statements.getInsertOrReplaceStatement(), true);
    }

    private long executeInsert(T entity, DatabaseStatement stmt, boolean setKeyAndAttach) {
        long rowId;
        if (db.isDbLockedByCurrentThread()) {
            rowId = insertInsideTx(entity, stmt);
        } else {
            // Do TX to acquire a connection before locking the stmt to avoid deadlocks
            db.beginTransaction();
            try {
                rowId = insertInsideTx(entity, stmt);
                db.setTransactionSuccessful();
            } finally {
                db.endTransaction();
            }
        }
        if (setKeyAndAttach) {
            updateKeyAfterInsertAndAttach(entity, rowId, true);
        }
        return rowId;
    }
</code></pre>

<h2 id="toc_5">QueryBuilder 构建查询语</h2>

<blockquote>
<p>支持函数查询条件 distinct、 where 、whereOr 、or 、and、 OrderAsc/Desc、 join、 limit/offset(分页两个合用) 等具体查看QueryBuilder API</p>

<p>构建对象 CursorQuery buildCursor()、List list()、 T unique()、 T uniqueOrThrow()、 DeleteQuery buildDelete() 等</p>
</blockquote>

<h2 id="toc_6">Property 配置where 条件判断</h2>

<ul>
<li>eq()：==</li>
<li>noteq()：!= ,&quot;&lt;&gt;?&quot;</li>
<li>gt()： &gt;</li>
<li>lt()：&lt;</li>
<li>ge：&gt;=</li>
<li>le:&lt;=</li>
<li>like()：包含</li>
<li>between：俩者之间</li>
<li>in：在某个值内</li>
<li>notIn：不在某个值内</li>
<li>isNull: is null</li>
<li>isNotNull: is not null</li>
</ul>

<h2 id="toc_7">分页查询</h2>

<ul>
<li>limit(int): 限制查询的数量;</li>
<li>offset(int): 每次返回的数量; offset不能单独使用;</li>
</ul>

<h2 id="toc_8">查询与LazyList类</h2>

<pre><code class="language-java">Query ： Query类表示一个查询能够执行很多次;而当通过QueryBuilder的任何查询方法（eg:list()）来获取查询结果时，querybuilder都会 在其内部创建Query来执行查询语句的;如果执行多次查询应该使用Query对象; 如果只想获取一个结果时可以使用Query(or QueryBuilder)中的unique()方法;

LazyList : 可以通过以下方法获取查询结果集合；

list() 缓存查询结果;list()类型一般为ArrayList

listLazy() 懒查询,只有当调用list()中的实体对象时才会执行查询操作并且只缓存第一次被查询的结果，需要关闭

listlazyUncached() 懒查询,只有当调用list()中的实体对象时才会执行查询操作并且不缓存;

listIterator() 对查询结果进行遍历，不缓存，需要关闭;后面三个类是LazyList中的方法，LazyList为了执行不同的缓存策略其内部持有数据库的cursor对象；一般情况下这三个方法执行完毕后会自动关闭cursor；但是防止在还没有执行完查询结果时，对象被终结cursor还是无法被关闭的情况发生，需要手动关闭close();

</code></pre>

<h2 id="toc_9">getDaoSession/getDatabase 开启事物处理</h2>

<h3 id="toc_10">getDatabase 开启</h3>

<pre><code class="language-java">Database database = getDaoSession().getMessageEntityDao().getDatabase();
     
     Cursor cursor = null;
        ArrayList&lt;MessageEntity&gt; dataList = new ArrayList&lt;MessageEntity&gt;();
        try {
            database.beginTransaction();

            cursor = database.rawQuery(sql, null);
            while (cursor.moveToNext()) {
                MessageEntity data = createMessageEntity(cursor);
                dataList.add(data);
            }
            database.setTransactionSuccessful();
        } catch (Exception e) {
            LogUtil.e(TAG, &quot;QueryMessageEntity &quot; + e);
        } finally {
            if (database != null)
                database.endTransaction();
            if (null != cursor) {
                cursor.close();
            }
        }
</code></pre>

<h3 id="toc_11">getDaoSession 开启</h3>

<pre><code class="language-java">    /**
     * Calls the given Callable inside a database transaction and returns the result of the Callable. If you don&#39;t
     * except a result, consider runInTx.
     */
    public &lt;V&gt; V callInTx(Callable&lt;V&gt; callable) throws Exception {
        db.beginTransaction();
        try {
            V result = callable.call();
            db.setTransactionSuccessful();
            return result;
        } finally {
            db.endTransaction();
        }
    }
</code></pre>

<h3 id="toc_12">callInTx 事物处理 执行查询操作</h3>

<pre><code class="language-java">    /**
     * @param type -1：设备账户 ，0：app主账户，1：app一般账户
     * @return
     */
    public synchronized ArrayList&lt;AccountInformation&gt; getUserData(final int type) {
        ArrayList&lt;AccountInformation&gt; userList = null;
        try {
            userList = (ArrayList&lt;AccountInformation&gt;) getDaoSession().callInTx(new Callable&lt;List&lt;AccountInformation&gt;&gt;() {
                @Override
                public List&lt;AccountInformation&gt; call() {
                    return getDaoSession().getAccountInformationDao().queryBuilder()
                            .where(AccountInformationDao.Properties.UserType.eq(type))
                            .build()
                            .list();
                }
            });

        } catch (Exception e) {
            LogUtil.e(TAG, &quot;getUserData &quot; + e);
        }
        return userList;
    }

</code></pre>

<h3 id="toc_13">getDaoSession runInTx 开启线程处理</h3>

<pre><code class="language-java">  * Run the given Runnable inside a database transaction. If you except a result, consider callInTx.
     */
    public void runInTx(Runnable runnable) {
        db.beginTransaction();
        try {
            runnable.run();
            db.setTransactionSuccessful();
        } finally {
            db.endTransaction();
        }
    }
</code></pre>

<h2 id="toc_14">insertOrReplace 新增或修改数据</h2>

<pre><code class="language-java"> /**
     * 增加或修改用户信息
     *
     * @param
     * @return
     */
    public synchronized boolean setUserData(AccountInformation entity) {
        try {
            AccountInformationDao dao = getDaoSession().getAccountInformationDao();
            AccountInformation user = dao.queryBuilder()
                   .where(AccountInformationDao.Properties.UserId.eq(entity.getUserId()))
                    .build()
                    .unique();
            if (user != null) {
                entity.setId(user.getId());
            }
            dao.insertOrReplace(entity);
            dao.refresh(entity);
            return true;
        } catch (Exception e) {
            LogUtil.e(TAG, &quot;setUserData &quot; + e);
            return false;
        }

    }
</code></pre>

<h2 id="toc_15">QueryBuilder 切换条件执行查询语句</h2>

<pre><code class="language-java">public synchronized ArrayList&lt;UrlInformation&gt; QueryUrlInfomationList(final int type, final int commandType, final String url, final long recordId, final int isUpload, final long createTime) {
        ArrayList&lt;UrlInformation&gt; dataList = null;

        try {
            dataList = (ArrayList&lt;UrlInformation&gt;) getDaoSession().callInTx(new Callable&lt;List&lt;UrlInformation&gt;&gt;() {
                @Override
                public List&lt;UrlInformation&gt; call() throws Exception {
                    UrlInformationDao dao = getDaoSession().getUrlInformationDao();
                    QueryBuilder&lt;UrlInformation&gt; queryBuilder = dao.queryBuilder();
                    if (type == 1) {
                        queryBuilder.where(UrlInformationDao.Properties.CommentType.eq(commandType));
                    } else if (type == 5) {
                        queryBuilder.where(UrlInformationDao.Properties.CommentType.eq(commandType),
                                UrlInformationDao.Properties.CreateTime.eq(createTime)
                        );
                    } else if (type == 6) {
                 /*       sql = &quot;select * from &quot; + Provider.UrlInformation.TABLE_NAME+ &quot; where &quot;
                                + Provider.UrlInformation.commentType + &quot; = &#39;&quot;+ commandType + &quot;&#39;&quot;
                                + &quot; and &quot;+ Provider.UrlInformation.url +&quot;&lt;&gt;&#39;&#39; and &#39;&quot;
                                +url +&quot;&#39; LIKE &#39;%&#39;||&quot;+Provider.UrlInformation.url + &quot;||&#39;%&#39;&quot;;*/

                        queryBuilder.where(UrlInformationDao.Properties.CommentType.eq(commandType),
                                UrlInformationDao.Properties.Url.like(&quot;%&quot; + url + &quot;%&quot;));
                    }

                    return queryBuilder.build().list();
                }
            });
        } catch (Exception e) {
            LogUtil.e(TAG, &quot;QueryUrlInfomationList &quot; + e);
        }

        return dataList;


</code></pre>

<h2 id="toc_16">执行SQL语句</h2>

<h3 id="toc_17">rawQuery queryRawCreate execSQL</h3>

<pre><code class="language-java">   public  long queryUserMaxId() {
            long id=0;

        try {
            UsersDao userDao = getDaoSession().getUsersDao();
            String sql = &quot;select max(&quot;+UsersDao.Properties.Id.columnName+&quot;) &quot;+UsersDao.Properties.Id.columnName+&quot; from &quot; + UsersDao.TABLENAME;
            sql = &quot;select max(_id) as maxId&quot;+&quot; from &quot; + UsersDao.TABLENAME;
           // sql=&quot;select *  from &quot;+UserDao.TABLENAME;
            Cursor cursor = userDao.getDatabase().rawQuery(sql, null);
            if (cursor.moveToNext()){//moveToNext moveToLast
                 //id = cursor.getLong(cursor.getColumnIndex(UserDao.Properties.Id.columnName));
                id = cursor.getLong(cursor.getColumnIndex(&quot;maxId&quot;));
                 Log.d(TAG,&quot;queryUserMaxId cursor users id=&quot;+id);
             }
             cursor.close();

           return id;

        } catch (Exception e) {
            e.printStackTrace();
            Log.d(TAG,&quot;queryUserMaxId cursor Exception&quot;+e);
        }
    return 0;
}
</code></pre>

<h2 id="toc_18">QueryBuilder buildDelete 带事物删除</h2>

<blockquote>
<p>适用于数据量比较大批量删除</p>
</blockquote>

<pre><code class="language-java">    /**
     * Builds a reusable query object for deletion (Query objects can be executed more efficiently than creating a
     * QueryBuilder for each execution.
     */
    public DeleteQuery&lt;T&gt; buildDelete() {
        if (!joins.isEmpty()) {
            throw new DaoException(&quot;JOINs are not supported for DELETE queries&quot;);
        }
        String tablename = dao.getTablename();
        String baseSql = SqlUtils.createSqlDelete(tablename, null);
        StringBuilder builder = new StringBuilder(baseSql);

        // tablePrefix gets replaced by table name below. Don&#39;t use tableName here because it causes trouble when
        // table name ends with tablePrefix.
        appendJoinsAndWheres(builder, tablePrefix);

        String sql = builder.toString();
        // Remove table aliases, not supported for DELETE queries.
        // TODO(?): don&#39;t create table aliases in the first place.
        sql = sql.replace(tablePrefix + &quot;.\&quot;&quot;, &#39;&quot;&#39; + tablename + &quot;\&quot;.\&quot;&quot;);
        checkLog(sql);

        return DeleteQuery.create(dao, sql, values.toArray());
    }

</code></pre>

<pre><code class="language-java">   /**
     * 删除所有家长端用户
     *
     * @param
     * @return
     */
    public synchronized boolean deleteUserByType() {
        try {

            getDaoSession().getAccountInformationDao().queryBuilder()
                    .where(AccountInformationDao.Properties.UserType.gt(-1))
                    .buildDelete().executeDeleteWithoutDetachingEntities();
            return true;
        } catch (Exception e) {
            LogUtil.e(TAG, &quot;deleteUserByType &quot; + e);
            return false;
        }

    }
</code></pre>

<h2 id="toc_19">Query SQL 查询</h2>

<blockquote>
<p>QueryBuilder&gt;build()<br/>
Query对象一旦生成就能多次被使用，你也可以为下一次查询增加查询条件</p>
</blockquote>

<pre><code class="language-java">Query query = userDao.queryBuilder().where( new 
StringCondition(&quot;_ID IN &quot; + &quot;(SELECT USER_ID FROM 
USER WHERE READ_ID = 0)&quot;)).build();

//分组查询
Query query = userDao.queryRawCreate( &quot;, GROUP G WHERE 
G.NAME=? AND T.GROUP_ID=G._ID&quot;, &quot;admin&quot;);


Query query = userDao.queryBuilder().where( 
userDao.Properties.IsRead.gt(0), 
userDao.Properties.DistinctName.eq(&quot;yes&quot;)).build();

List userFirst = query.list(); 

query.setParameter(0, 1);
query.setParameter(1, &quot;no&quot;);

List userSecond = query.list();
</code></pre>

<h2 id="toc_20">自定义SQL 拼接多个查询语句</h2>

<pre><code class="language-java">  /**
     * 聊天消息查询
     *
     * @param type      1： 根据messaId查询，2：查询所有消息，3：群消息根据时间查询（大于），4：群消息根据时间查询（小于）,5：私聊消息根据时间查询（大于），
     *                  6：私聊消息根据时间查询（小于）,7：当前消息根据时间查询（大于），6：当前消息根据时间查询（小于）
     * @param messageId 消息Id  传私人Id为私聊消息，传群Id,为群聊消息
     * @param time      时间
     * @param order     只能传 DESC(由大到小)和ASC(由小到大)
     * @param size      查询数据的数量
     * @return
     * @userId userId：自己用户id
     * @groupId 私聊方Id或群id
     */
    public synchronized ArrayList&lt;MessageEntity&gt; QueryMessageList(int type, long messageId, long userId, long reuserid, String time, int size, String order) {
        String sql = null;
        Database database = getDaoSession().getMessageEntityDao().getDatabase();
        if (type == 1) {
            sql = &quot;select * from &quot; + MessageEntityDao.TABLENAME
                    + &quot; where &quot; + MessageEntityDao.Properties.MessageId.columnName + &quot; = &#39;&quot; + messageId + &quot;&#39;&quot;;

        } else if (type == 2) {
            sql = &quot;select * from &quot; + MessageEntityDao.TABLENAME;
        } else if (type == 3) {
            sql = &quot;select * from &quot; + MessageEntityDao.TABLENAME
                    + &quot; where &quot; + MessageEntityDao.Properties.ReuserId.columnName + &quot; = &#39;&quot; + reuserid + &quot;&#39;&quot;
                    + &quot; and &quot; + MessageEntityDao.Properties.CreateTime.columnName + &quot; &gt; &#39;&quot; + time + &quot;&#39;&quot;
                    + &quot; order by &quot; + MessageEntityDao.Properties.CreateTime.columnName + &quot; &quot; + order + &quot; limit &#39;&quot; + size + &quot;&#39; offset &#39;&quot; + 0 + &quot;&#39;&quot;;
        } else if (type == 4) {
            sql = &quot;select * from &quot; + MessageEntityDao.TABLENAME
                    + &quot; where &quot; + MessageEntityDao.Properties.ReuserId.columnName + &quot; = &#39;&quot; + reuserid + &quot;&#39;&quot;
                    + &quot; and &quot; + MessageEntityDao.Properties.CreateTime.columnName + &quot; &lt; &#39;&quot; + time + &quot;&#39;&quot;
                    + &quot; order by &quot; + MessageEntityDao.Properties.CreateTime.columnName + &quot; &quot; + order + &quot; limit &#39;&quot; + size + &quot;&#39; offset &#39;&quot; + 0 + &quot;&#39;&quot;;
        } else if (type == 5) {
            sql = &quot;select * from &#39;&quot; + MessageEntityDao.TABLENAME + &quot;&#39;&quot; + &quot; where &quot;
                    + &quot; ( &quot; + &quot; ( &quot; + MessageEntityDao.Properties.UserId.columnName + &quot; = &#39;&quot; + reuserid + &quot;&#39; and &quot;
                    + MessageEntityDao.Properties.ReuserId.columnName + &quot; = &#39;&quot; + userId + &quot;&#39; ) &quot; + &quot; or &quot;
                    + &quot; ( &quot; + MessageEntityDao.Properties.UserId.columnName + &quot; = &#39;&quot; + userId + &quot;&#39; and &quot;
                    + MessageEntityDao.Properties.ReuserId.columnName + &quot; = &#39;&quot; + reuserid + &quot;&#39; ) &quot; + &quot; ) &quot;
                    + &quot; and &quot; + MessageEntityDao.Properties.CreateTime.columnName + &quot; &gt; &#39;&quot; + time + &quot;&#39;&quot;
                    + &quot; order by &quot; + MessageEntityDao.Properties.CreateTime.columnName + &quot; &quot; + order + &quot; limit &#39;&quot; + size + &quot;&#39; offset &#39;&quot; + 0 + &quot;&#39;&quot;;
        } else if (type == 6) {
            sql = &quot;select * from &#39;&quot; + MessageEntityDao.TABLENAME + &quot;&#39;&quot; + &quot; where &quot;
                    + &quot; ( &quot; + &quot; ( &quot; + MessageEntityDao.Properties.UserId.columnName + &quot; = &#39;&quot; + reuserid + &quot;&#39; and &quot;
                    + MessageEntityDao.Properties.ReuserId.columnName + &quot; = &#39;&quot; + userId + &quot;&#39; ) &quot; + &quot; or &quot;
                    + &quot; ( &quot; + MessageEntityDao.Properties.UserId.columnName + &quot; = &#39;&quot; + userId + &quot;&#39; and &quot;
                    + MessageEntityDao.Properties.ReuserId.columnName + &quot; = &#39;&quot; + reuserid + &quot;&#39; ) &quot; + &quot; ) &quot;
                    + &quot; and &quot; + MessageEntityDao.Properties.CreateTime.columnName + &quot; &lt; &#39;&quot; + time + &quot;&#39;&quot;
                    + &quot; order by &quot; + MessageEntityDao.Properties.CreateTime.columnName + &quot; &quot; + order + &quot; limit &#39;&quot; + size + &quot;&#39; offset &#39;&quot; + 0 + &quot;&#39;&quot;;
        } else if (type == 7) {
            sql = &quot;select * from &#39;&quot; + MessageEntityDao.TABLENAME + &quot;&#39;&quot; + &quot; where &quot;
                    + MessageEntityDao.Properties.CreateTime.columnName + &quot; &gt; &#39;&quot; + time + &quot;&#39;&quot;
                    + &quot; order by &quot; + MessageEntityDao.Properties.CreateTime.columnName + &quot; &quot; + order + &quot; limit &#39;&quot; + size + &quot;&#39; offset &#39;&quot; + 0 + &quot;&#39;&quot;;
        } else if (type == 8) {
            sql = &quot;select * from messagelist t where EXISTS ( select 1 from messagelist GROUP BY distinctName HAVING MAX(_id) = t._id)&quot;
                    + &quot; and &quot; + MessageEntityDao.Properties.CreateTime.columnName + &quot; &lt; &#39;&quot; + time + &quot;&#39;&quot;
                    + &quot; order by &quot; + MessageEntityDao.Properties.CreateTime.columnName + &quot; &quot; + order + &quot; limit &#39;&quot; + size + &quot;&#39; offset &#39;&quot; + 0 + &quot;&#39;&quot;;

            //+Provider.MessageEntity.commenType + &quot; = &#39;&quot; + comment + &quot;&#39;&quot;
            //SELECT * FROM test_table t WHERE EXISTS ( SELECT 1 FROM test_table  GROUP BY uname HAVING MAX(id) = t.id )
        }
        LogUtil.d(TAG, &quot;QueryMessageEntity ,sql:&quot; + sql);


        Cursor cursor = null;
        ArrayList&lt;MessageEntity&gt; dataList = new ArrayList&lt;MessageEntity&gt;();
        try {
            database.beginTransaction();

            cursor = database.rawQuery(sql, null);
            while (cursor.moveToNext()) {
                MessageEntity data = createMessageEntity(cursor);
                dataList.add(data);
            }
            database.setTransactionSuccessful();
        } catch (Exception e) {
            LogUtil.e(TAG, &quot;QueryMessageEntity &quot; + e);
        } finally {
            if (database != null)
                database.endTransaction();
            if (null != cursor) {
                cursor.close();
            }
        }
        return dataList;
    }
</code></pre>

<pre><code class="language-java">   /**
     * 创建消息实体
     *
     * @param cursor
     * @return
     */
    public MessageEntity createMessageEntity(Cursor cursor) {
        MessageEntity data = new MessageEntity();
        data.setChatType(cursor.getInt(cursor.getColumnIndex(MessageEntityDao.Properties.ChatType.columnName)));
        data.setMessageId(cursor.getLong(cursor.getColumnIndex(MessageEntityDao.Properties.MessageId.columnName)));
        data.setMessageType(cursor.getInt(cursor.getColumnIndex(MessageEntityDao.Properties.MessageType.columnName)));
        data.setUserId(cursor.getLong(cursor.getColumnIndex(MessageEntityDao.Properties.UserId.columnName)));
        data.setUserName(cursor.getString(cursor.getColumnIndex(MessageEntityDao.Properties.UserName.columnName)));
        data.setUserPic(cursor.getString(cursor.getColumnIndex(MessageEntityDao.Properties.UserPic.columnName)));
        data.setReuserId(cursor.getLong(cursor.getColumnIndex(MessageEntityDao.Properties.ReuserId.columnName)));
        data.setReuserName(cursor.getString(cursor.getColumnIndex(MessageEntityDao.Properties.ReuserName.columnName)));
        data.setReuserPic(cursor.getString(cursor.getColumnIndex(MessageEntityDao.Properties.ReuserPic.columnName)));
        data.setMcontent(cursor.getString(cursor.getColumnIndex(MessageEntityDao.Properties.Mcontent.columnName)));
        data.setCreateTime(cursor.getString(cursor.getColumnIndex(MessageEntityDao.Properties.CreateTime.columnName)));
        data.setIsRead(cursor.getInt(cursor.getColumnIndex(MessageEntityDao.Properties.IsRead.columnName)));
        data.setIsSend(cursor.getInt(cursor.getColumnIndex(MessageEntityDao.Properties.IsSend.columnName)));
        data.setMessageSize(cursor.getInt(cursor.getColumnIndex(MessageEntityDao.Properties.MessageSize.columnName)));
        data.setSubCode(cursor.getInt(cursor.getColumnIndex(MessageEntityDao.Properties.SubCode.columnName)));
        data.setSendType(cursor.getInt(cursor.getColumnIndex(MessageEntityDao.Properties.SendType.columnName)));
        data.setReceType(cursor.getInt(cursor.getColumnIndex(MessageEntityDao.Properties.ReceType.columnName)));
        data.setSubGroup(cursor.getInt(cursor.getColumnIndex(MessageEntityDao.Properties.SubGroup.columnName)));
        data.setLocalityContent(cursor.getString(cursor.getColumnIndex(MessageEntityDao.Properties.LocalityContent.columnName)));
        data.setDistinctName(cursor.getString(cursor.getColumnIndex(MessageEntityDao.Properties.DistinctName.columnName)));
        return data;

    }
</code></pre>


</div>

<br /><br />
<hr />

<div class="content-nav">
    <div class="large-6 columns">
        <div class="text-left" style="padding:15px 0px;">
            
            <a href="16251022251527.html" title="Previous Post: Android—Glide使用教程（三）">&laquo; Android—Glide使用教程（三）</a> 
        </div>
    </div>
    <div class="large-6 columns">
        <div class="text-right" style="padding:15px 0px;">
            
        </div>
    </div>
</div>

<div class="content_share">
    <div style="padding:0px 0.93em;" class="share-comments">
        
    </div>
</div>
<script type="text/javascript">
    $(function() {
        var currentURL = '16280610843145.html';
        $('#side-nav a').each(function() {
            if ($(this).attr('href') == currentURL) {
                $(this).parent().addClass('active');
            }
        });
    });
</script>  </div>
</div>


<div class="page-bottom">
    <div class="copyright">
        <a href="mailto:888api@sina.com">郝彬彬</a> &copy; 
    </div>
    <div class="copyright text-right">
        <a href="#main-content">TOP</a>
    </div>
</div>

</div>




  














<style type="text/css">
    figure {
        margin: 0.4em 0;
        padding: 0;
    }
    
    figcaption {
        text-align: center;
    }
    /* PrismJS 1.14.0
 http://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript */
    /**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */
    
    code[class*="language-"],
    pre[class*="language-"] {
        color: black;
        background: none;
        text-shadow: 0 1px white;
        font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        line-height: 1.5;
        -moz-tab-size: 4;
        -o-tab-size: 4;
        tab-size: 4;
        -webkit-hyphens: none;
        -moz-hyphens: none;
        -ms-hyphens: none;
        hyphens: none;
    }
    
    pre[class*="language-"]::-moz-selection,
    pre[class*="language-"] ::-moz-selection,
    code[class*="language-"]::-moz-selection,
    code[class*="language-"] ::-moz-selection {
        text-shadow: none;
        background: #b3d4fc;
    }
    
    pre[class*="language-"]::selection,
    pre[class*="language-"] ::selection,
    code[class*="language-"]::selection,
    code[class*="language-"] ::selection {
        text-shadow: none;
        background: #b3d4fc;
    }
    
    @media print {
        code[class*="language-"],
        pre[class*="language-"] {
            text-shadow: none;
        }
    }
    /* Code blocks */
    
    pre[class*="language-"] {
        padding: 1em;
        margin: .5em 0;
        overflow: auto;
    }
    
     :not(pre)>code[class*="language-"],
    pre[class*="language-"] {
        background: #F7F7F7;
    }
    /* Inline code */
    
     :not(pre)>code[class*="language-"] {
        padding: .1em;
        border-radius: .3em;
        white-space: normal;
    }
    
    .token.comment,
    .token.prolog,
    .token.doctype,
    .token.cdata {
        color: slategray;
    }
    
    .token.punctuation {
        color: #999;
    }
    
    .namespace {
        opacity: .7;
    }
    
    .token.property,
    .token.tag,
    .token.boolean,
    .token.number,
    .token.constant,
    .token.symbol,
    .token.deleted {
        color: #905;
    }
    
    .token.selector,
    .token.attr-name,
    .token.string,
    .token.char,
    .token.builtin,
    .token.inserted {
        color: #690;
    }
    
    .token.operator,
    .token.entity,
    .token.url,
    .language-css .token.string,
    .style .token.string {
        color: #9a6e3a;
        background: hsla(0, 0%, 100%, .5);
    }
    
    .token.atrule,
    .token.attr-value,
    .token.keyword {
        color: #07a;
    }
    
    .token.function,
    .token.class-name {
        color: #DD4A68;
    }
    
    .token.regex,
    .token.important,
    .token.variable {
        color: #e90;
    }
    
    .token.important,
    .token.bold {
        font-weight: bold;
    }
    
    .token.italic {
        font-style: italic;
    }
    
    .token.entity {
        cursor: help;
    }
    
    pre[class*="language-"].line-numbers {
        position: relative;
        padding-left: 3.8em;
        counter-reset: linenumber;
    }
    
    pre[class*="language-"].line-numbers>code {
        position: relative;
        white-space: inherit;
    }
    
    .line-numbers .line-numbers-rows {
        position: absolute;
        pointer-events: none;
        top: 0;
        font-size: 100%;
        left: -3.8em;
        width: 3em;
        /* works for line-numbers below 1000 lines */
        letter-spacing: -1px;
        border-right: 1px solid #999;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    .line-numbers-rows>span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
    }
    
    .line-numbers-rows>span:before {
        content: counter(linenumber);
        color: #999;
        display: block;
        padding-right: 0.8em;
        text-align: right;
    }
</style>

<script src="asset/js/foundation.min.js"></script>
<script src="asset/js/foundation/foundation.offcanvas.js"></script>
<script>
    $(document).foundation();
</script>
<script src="asset/js/watermark.js"></script>

</body>

</html>