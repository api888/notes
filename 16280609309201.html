<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        烂笔头
    </title>
    <meta name="description" content="">
    <link href="atom.xml" rel="alternate" title="烂笔头" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>
        hljs.initHighlightingOnLoad();
    </script>

</head>

<body class="antialiased hide-extras"></body>

<div class="inner-wrap">


    <nav class="top-bar docs-bar hide-for-small" data-topbar>

        <div id="header">
            <h1><a href="index.html">烂笔头</a></h1>
        </div>

    </nav>


    <div class="row">
        <div class="sidebar">
            <ul id="side-nav" class="side-nav">

                
                <li class="side-title"><span>Android</span></li>
                
                <li><a title="移除第三方SDK所声明的权限" href="16280619241100.html">移除第三方SDK所声明的权限</a></li>
                
                <li><a title="Android登录页面，未勾选用户协议、隐私政策出现抖动效果" href="16280609822586.html">Android登录页面，未勾选用户协议、隐私政策出现抖动效果</a></li>
                
                <li><a title="DialogFragment内存泄露问题能不能一次性改好" href="16251021954820.html">DialogFragment内存泄露问题能不能一次性改好</a></li>
                
                <li><a title="Android静默安装实现方案，仿360手机助手秒装和智能安装功能" href="16251021954779.html">Android静默安装实现方案，仿360手机助手秒装和智能安装功能</a></li>
                
                <li><a title="Android 添加水印功能" href="16251021954737.html">Android 添加水印功能</a></li>
                
                <li><a title="Android 监听手电筒状态" href="16251021954689.html">Android 监听手电筒状态</a></li>
                 
                <li class="side-title"><span>Github</span></li>
                
                <li><a title="使用Github+jsdelivr构建你的免费图床" href="16251022060206.html">使用Github+jsdelivr构建你的免费图床</a></li>
                 
                <li class="side-title"><span>Glide</span></li>
                
                <li><a title="Glide源码修改-自定义磁盘缓存实现永久存储" href="16251022251608.html">Glide源码修改-自定义磁盘缓存实现永久存储</a></li>
                
                <li><a title="Android—Glide使用教程（一）" href="16251022251568.html">Android—Glide使用教程（一）</a></li>
                
                <li><a title="Android—Glide使用教程（二）" href="16251022251484.html">Android—Glide使用教程（二）</a></li>
                
                <li><a title="Android—Glide使用教程（三）" href="16251022251527.html">Android—Glide使用教程（三）</a></li>
                 
                <li class="side-title"><span>Gradle</span></li>
                
                <li><a title="Gradle 自定义Plugin插件之上传APK到蒲公英" href="16280610391708.html">Gradle 自定义Plugin插件之上传APK到蒲公英</a></li>
                
                <li><a title="自定义Gradle Plugin，优雅的解决第三方Jar包中的bug" href="16280610391664.html">自定义Gradle Plugin，优雅的解决第三方Jar包中的bug</a></li>
                
                <li><a title="如何使用Android Studio开发Gradle插件" href="16280610391616.html">如何使用Android Studio开发Gradle插件</a></li>
                
                <li><a title="sourceSets使用" href="16251022385733.html">sourceSets使用</a></li>
                
                <li><a title="脑洞大开，Gradle项目管理依赖的船新版本" href="16251022385689.html">脑洞大开，Gradle项目管理依赖的船新版本</a></li>
                 
                <li class="side-title"><span>Rxjava</span></li>
                
                <li><a title="RxJava2 只看这一篇文章就够了" href="16251022491138.html">RxJava2 只看这一篇文章就够了</a></li>
                 
                <li class="side-title"><span>GreenDAO</span></li>
                
                <li><a title="GreenDao 3.3.0 基本使用与入门 （一）" href="16280610693006.html">GreenDao 3.3.0 基本使用与入门 （一）</a></li>
                
                <li><a title="GreenDao 3.3.0 多表关联使用（二）" href="16280610765764.html">GreenDao 3.3.0 多表关联使用（二）</a></li>
                
                <li><a title="GreenDao 3.3.0 增删改查的使用（三）" href="16280610843145.html">GreenDao 3.3.0 增删改查的使用（三）</a></li>
                 
                <li class="side-title"><span>组件化</span></li>
                
                <li><a title="组件化架构之解决Common组件中心化问题(api化方案)" href="16280609309201.html">组件化架构之解决Common组件中心化问题(api化方案)</a></li>
                 
            </ul>
        </div>
        <div class="columns"> <div id="main-content" class="markdown-body">
    <h1>组件化架构之解决Common组件中心化问题(api化方案)</h1>

    <ul>
<li>
<a href="#toc_0">Common组件中心化问题</a>
<ul>
<li>
<a href="#toc_1">分析问题</a>
</li>
<li>
<a href="#toc_2">结论</a>
</li>
</ul>
</li>
<li>
<a href="#toc_3">“两个组件间共用的代码” 如何存放</a>
</li>
<li>
<a href="#toc_4">自动生成“sdk”</a>
<ul>
<li>
<a href="#toc_5">自动生成sdk —— include_with_api.gradle</a>
</li>
<li>
<a href="#toc_6">对于需要生成sdk的ComponentA需要做的事情</a>
<ul>
<li>
<a href="#toc_7">将需要包含在sdk里的文件结尾全部加上“_api”</a>
</li>
<li>
<a href="#toc_8">修改Android Studio里的File Types</a>
</li>
<li>
<a href="#toc_9">为sdk module提供AndroidManifest.xml_api</a>
</li>
<li>
<a href="#toc_10">为sdk module提供build.gradle_api</a>
</li>
<li>
<a href="#toc_11">依赖 ComponentA_api</a>
</li>
</ul>
</li>
<li>
<a href="#toc_12">对于需要使用到sdk的ComponentB需要做的事情</a>
</li>
</ul>
</li>
<li>
<a href="#toc_13">Demo</a>
</li>
</ul>


<p><a href="https://blog.csdn.net/taotao110120119/article/details/110434164">原文</a></p>

<h1 id="toc_0">Common组件中心化问题</h1>

<p>一般的组件化架构的结构是这样的:</p>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20201201152819629.png" alt=""/></p>

<p>随着业务的不断增加，我们都会遇到一个问题，就是common组件越来越大，里面的代码越来越乱，该组件就会变得比较臃肿，难以维护。</p>

<h2 id="toc_1">分析问题</h2>

<p>问题的出现都是有原因的，我们来分析一下common组件里都放了什么内容：</p>

<ol>
<li><p>整个项目的一些base的代码</p>
<p>比如BaseActivity,BaseFragment等一些base代码。</p>
<blockquote>
<p>分析：这种base代码放在common里确实是比较合适的。</p>
</blockquote></li>
<li><p>两个组件间共用的代码</p>
<p>比如数据类和网络接口类。A组件和B组件都用到了某个网络接口返回某个数据。此时对于这个数据类和网络接口类貌似也只能放在common组件里。</p>
<blockquote>
<p>分析：两个组件间共用一些代码是很常见的场景，但是把这些代码放在common里合适吗？</p>
</blockquote>
<p>common是被所有组件模块所依赖的，所以common的含义应该是所有组件公共的代码才能叫common,两个组件间公共的代码不应该放在common里。</p>
<p>而且把两个组件间共用的代码放在common里也会被其他不应该依赖这些代码的组件依赖到，就有可能会被这些组件误使用到。我们知道隔离的最好方式就是编译隔离，所以根本的解决方案就是让其他的组件不能编译依赖到这些代码。</p>
<p>应该如何实现呢？我们下面会说到。</p></li>
<li><p>基础功能的代码</p>
<p>有些项目呢会把图片加载，网络访问等一些基础功能的代码在common组件里建一个image,network文件夹来进行存放。</p>
<blockquote>
<p>分析：这样也是不合理的，这些基础功能应该放在基础组件层，新建一个独立的组件来存放。这个问题比较清晰，我们不过多讨论。</p>
</blockquote></li>
</ol>

<h2 id="toc_2">结论</h2>

<p>所以，经过分析，我们主要需要解决的问题就是两个组件间共用的代码如何存放的问题。</p>

<h1 id="toc_3">“两个组件间共用的代码” 如何存放</h1>

<p>一般遇到这种情况的场景是，A组件有某个功能，但是B组件需要用到该功能，此时可以通过A组件提供出来一个“sdk”给到B组件来使用。<br/>
“sdk”里包含两部分内容</p>

<ol>
<li>数据类，</li>
<li>该功能的接口<br/>
暴漏接口类，而不是具体实现类，这样B组件就只依赖了该功能的接口而不是具体实现</li>
</ol>

<p>&quot;sdk&quot;起到的作用就是“两个组件间的common”，这样就避免了把“两个组件间的common”放在了“所有组件间的common”组件里。</p>

<h1 id="toc_4">自动生成“sdk”</h1>

<p>A组件提供“sdk”给B组件，就如下图所示：</p>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20201201173157324.png" alt=""/></p>

<p>其中ServiceManager的角色<a href="https://github.com/alibaba/ARouter/blob/master/README_CN.md">ARouter</a>已经帮我们实现了，不想重复造车的可以直接使用ARouter。</p>

<p>我们这里主要讨论的是sdk组件如何来生成，sdk组件也是一个module，如果我们每次都要新建module，手动将接口和数据类摘到新module里岂不是很繁琐。我们可以使用gradle脚本帮我们实现这个功能。</p>

<h2 id="toc_5">自动生成sdk —— include_with_api.gradle</h2>

<pre><code class="language-groovy">ext {
    include_with_api = { moduleName -&gt;
        include(moduleName)
        //获得module的根目录
        String originDir = project(moduleName).projectDir
        //制作的 SDK module的目录
        String targetDir = &quot;${originDir}_api&quot;
        //制作的 SDK module的名字
        String sdkName = &quot;${project(moduleName).name}_api&quot;
        System.out.println(&quot;-------------------------------------SDK name:&quot; + sdkName)
        //删除掉 SDK module目录 里所有的文件 除了 iml
        // （这里之所以做删除，是因为有可能之前已经生成过该SDK module，所以在再次生成的时候先把之前生成的module里的文件删掉）
        FileTree targetFiles = fileTree(targetDir)
        targetFiles.exclude &quot;*.iml&quot;
        targetFiles.each { File file -&gt;
            file.delete()
        }
        //从生成SDK的源module拷贝 _api 文件到 SDK module
        copy {
            from originDir
            into targetDir
            //拷贝文件
            include &#39;**/*_api&#39;
        }

        // 将 _api 文件的 &quot;_api&quot; 去掉
        FileTree files = fileTree(targetDir).include(&quot;**/*_api&quot;)
        files.each {
            File file -&gt;
                file.renameTo(new File(file.absolutePath.substring(0,file.absolutePath.lastIndexOf(&quot;_api&quot;))))
        }
        //加入 SDK module
        include &quot;$sdkName&quot;
    }
}
</code></pre>

<p>include_with_api方法会在settings.gradle里使用</p>

<p>settings.gradle:</p>

<pre><code class="language-groovy">apply from: &#39;./include_with_api.gradle&#39;

include &#39;:ComponentB&#39;
include &#39;:app&#39;
rootProject.name = &quot;ComponentizationDemo&quot;

//对于需要生成api的module,使用该方法来进行include
include_with_api(&#39;:ComponentA&#39;)
</code></pre>

<blockquote>
<p>解释一下include_with_api.gradle：<br/>
该方法的作用，是当你在settings.gradle里去include 一个组件ComponentA的时候，该方法会新建一个ComponentA_api 的module， 扫描ComponentA里所有以“_api”结尾的文件，然后将这些文件全部拷贝到ComponentA_api里，然后去掉文件结尾的“_api”，最后再include ComponentA_api。</p>
</blockquote>

<h2 id="toc_6">对于需要生成sdk的ComponentA需要做的事情</h2>

<h3 id="toc_7">将需要包含在sdk里的文件结尾全部加上“_api”</h3>

<p>这里可以是.java,.kt,.xml等任意类型的文件。我们大多数情况需要共享的是java和kotlin代码，但有些情况还需要共享资源文件，比如图片资源，string资源等，这些都是支持的。</p>

<p>我们以.kt文件为例</p>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20201203155700892.jpg" alt=""/></p>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20201203155719158.png" alt=""/></p>

<h3 id="toc_8">修改Android Studio里的File Types</h3>

<p>修改File Types后，Android Studio就会把.kt_api文件当做Kotlin文件来解析。</p>

<p>我们以.kt文件为例，其他类型也是一样的方法。</p>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20201203155739442.png" alt=""/></p>

<h3 id="toc_9">为sdk module提供AndroidManifest.xml_api</h3>

<p>ComponentA工程本身的AndroidManifest.xml文件并不适合sdk module，所以我们需要为sdk module 提供一个AndroidManifest.xml，文件后面加上“_api”就会自动包含进 sdk module。内容一般就是空内容，package 是ComponentA的package 后面加上.api</p>

<p>AndroidManifest.xml_api:</p>

<pre><code class="language-markup">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    package=&quot;com.jst.componenta.api&quot;&gt;

&lt;/manifest&gt;
</code></pre>

<h3 id="toc_10">为sdk module提供build.gradle_api</h3>

<p>ComponentA工程本身的build.gradle文件并不适合sdk module，所以我们需要为sdk module 提供一个build.gradle，文件后面加上“_api”就会自动包含进 sdk module。内容根据实际情况来确定。</p>

<h3 id="toc_11">依赖 ComponentA_api</h3>

<p>ComponentA 也是要依赖生成的ComponentA_api，为了方便，我们写了一个compileApi.gradle，自动帮你添加“_api”</p>

<p>compileApi.gradle:</p>

<pre><code class="language-groovy">ext {
    compileApi = { moduleName -&gt;

        println &quot;######  compileApi  moduleName ${moduleName}_api ######&quot;
        dependencies {
            api project(&quot;${moduleName}_api&quot;)
        }
    }
}
</code></pre>

<p>在ComponentA的build.gradle中：</p>

<pre><code class="language-groovy">apply from: &#39;../compileApi.gradle&#39;
dependencies {
    compileApi(&quot;:ComponentA&quot;)
}
</code></pre>

<h2 id="toc_12">对于需要使用到sdk的ComponentB需要做的事情</h2>

<p>只是依赖 ComponentA_api 就可以了。</p>

<p>在ComponentB的build.gradle中：</p>

<pre><code class="language-groovy">apply from: &#39;../compileApi.gradle&#39;
dependencies {
    compileApi(&quot;:ComponentA&quot;)
}
</code></pre>

<h1 id="toc_13">Demo</h1>

<p>我们的Demo演示了一个ComponentA 提供sdk 给 ComponentB的场景,使用上述的方法来自动生成ComponentA_api,同时我们使用ARouter作为我们的ServiceManager.最终我们在ComponentB里使用到了ComponentA里提供的具体服务，并且ComponentB只依赖了ComponentA所提供出来的接口类和数据类。</p>

<p>我们分别演示了Java代码和Kotlin代码两种场景。</p>

<ul>
<li>ComponentA：</li>
</ul>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20201203163015909.png" alt=""/></p>

<p>自动生成的 ComponentA_api：</p>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/2020120316315856.png" alt=""/></p>

<ul>
<li>ComponentB:</li>
</ul>

<p><img src="https://cdn.jsdelivr.net/gh/api888/PublicPic@main//img/20201203163324790.png" alt=""/></p>

<p>我们在ComponentB里拿到了ComponentA里的服务提供的数据：</p>

<pre><code class="language-kotlin">class ComponentBActivity : AppCompatActivity() {
    lateinit var iServiceJava:IServiceJava
    lateinit var iServiceKotlin:IServiceKotlin

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_component_b)
        textView.setText(&quot;This is ComponentBActivity&quot;)

        //java 版本的
        iServiceJava = ARouter.getInstance().navigation(IServiceJava::class.java)
        textViewJava.setText(iServiceJava.getData().data)

        //kotlin 版本的
        iServiceKotlin = ARouter.getInstance().navigation(IServiceKotlin::class.java)
        textViewKotlin.setText(iServiceKotlin.getData().data)
    }
}
</code></pre>

<p><a href="https://github.com/ShuangtaoJia/ComponentizationDemo">Demo地址</a></p>


</div>

<br /><br />
<hr />

<div class="content-nav">
    <div class="large-6 columns">
        <div class="text-left" style="padding:15px 0px;">
            
            <a href="16280609822586.html" title="Previous Post: Android登录页面，未勾选用户协议、隐私政策出现抖动效果">&laquo; Android登录页面，未勾选用户协议、隐私政策出现抖动效果</a> 
        </div>
    </div>
    <div class="large-6 columns">
        <div class="text-right" style="padding:15px 0px;">
            
            <a href="16251022491138.html" title="Next Post: RxJava2 只看这一篇文章就够了">RxJava2 只看这一篇文章就够了 &raquo;</a> 
        </div>
    </div>
</div>

<div class="content_share">
    <div style="padding:0px 0.93em;" class="share-comments">
        
    </div>
</div>
<script type="text/javascript">
    $(function() {
        var currentURL = '16280609309201.html';
        $('#side-nav a').each(function() {
            if ($(this).attr('href') == currentURL) {
                $(this).parent().addClass('active');
            }
        });
    });
</script>  </div>
</div>


<div class="page-bottom">
    <div class="copyright">
        <a href="mailto:888api@sina.com">郝彬彬</a> &copy; 
    </div>
    <div class="copyright text-right">
        <a href="#main-content">TOP</a>
    </div>
</div>

</div>




  














<style type="text/css">
    figure {
        margin: 0.4em 0;
        padding: 0;
    }
    
    figcaption {
        text-align: center;
    }
    /* PrismJS 1.14.0
 http://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript */
    /**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */
    
    code[class*="language-"],
    pre[class*="language-"] {
        color: black;
        background: none;
        text-shadow: 0 1px white;
        font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        line-height: 1.5;
        -moz-tab-size: 4;
        -o-tab-size: 4;
        tab-size: 4;
        -webkit-hyphens: none;
        -moz-hyphens: none;
        -ms-hyphens: none;
        hyphens: none;
    }
    
    pre[class*="language-"]::-moz-selection,
    pre[class*="language-"] ::-moz-selection,
    code[class*="language-"]::-moz-selection,
    code[class*="language-"] ::-moz-selection {
        text-shadow: none;
        background: #b3d4fc;
    }
    
    pre[class*="language-"]::selection,
    pre[class*="language-"] ::selection,
    code[class*="language-"]::selection,
    code[class*="language-"] ::selection {
        text-shadow: none;
        background: #b3d4fc;
    }
    
    @media print {
        code[class*="language-"],
        pre[class*="language-"] {
            text-shadow: none;
        }
    }
    /* Code blocks */
    
    pre[class*="language-"] {
        padding: 1em;
        margin: .5em 0;
        overflow: auto;
    }
    
     :not(pre)>code[class*="language-"],
    pre[class*="language-"] {
        background: #F7F7F7;
    }
    /* Inline code */
    
     :not(pre)>code[class*="language-"] {
        padding: .1em;
        border-radius: .3em;
        white-space: normal;
    }
    
    .token.comment,
    .token.prolog,
    .token.doctype,
    .token.cdata {
        color: slategray;
    }
    
    .token.punctuation {
        color: #999;
    }
    
    .namespace {
        opacity: .7;
    }
    
    .token.property,
    .token.tag,
    .token.boolean,
    .token.number,
    .token.constant,
    .token.symbol,
    .token.deleted {
        color: #905;
    }
    
    .token.selector,
    .token.attr-name,
    .token.string,
    .token.char,
    .token.builtin,
    .token.inserted {
        color: #690;
    }
    
    .token.operator,
    .token.entity,
    .token.url,
    .language-css .token.string,
    .style .token.string {
        color: #9a6e3a;
        background: hsla(0, 0%, 100%, .5);
    }
    
    .token.atrule,
    .token.attr-value,
    .token.keyword {
        color: #07a;
    }
    
    .token.function,
    .token.class-name {
        color: #DD4A68;
    }
    
    .token.regex,
    .token.important,
    .token.variable {
        color: #e90;
    }
    
    .token.important,
    .token.bold {
        font-weight: bold;
    }
    
    .token.italic {
        font-style: italic;
    }
    
    .token.entity {
        cursor: help;
    }
    
    pre[class*="language-"].line-numbers {
        position: relative;
        padding-left: 3.8em;
        counter-reset: linenumber;
    }
    
    pre[class*="language-"].line-numbers>code {
        position: relative;
        white-space: inherit;
    }
    
    .line-numbers .line-numbers-rows {
        position: absolute;
        pointer-events: none;
        top: 0;
        font-size: 100%;
        left: -3.8em;
        width: 3em;
        /* works for line-numbers below 1000 lines */
        letter-spacing: -1px;
        border-right: 1px solid #999;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    .line-numbers-rows>span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
    }
    
    .line-numbers-rows>span:before {
        content: counter(linenumber);
        color: #999;
        display: block;
        padding-right: 0.8em;
        text-align: right;
    }
</style>

<script src="asset/js/foundation.min.js"></script>
<script src="asset/js/foundation/foundation.offcanvas.js"></script>
<script>
    $(document).foundation();
</script>
<script src="asset/js/watermark.js"></script>

</body>

</html>