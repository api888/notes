<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        烂笔头
    </title>
    <meta name="description" content="">
    <link href="atom.xml" rel="alternate" title="烂笔头" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>
        hljs.initHighlightingOnLoad();
    </script>

</head>

<body class="antialiased hide-extras"></body>

<div class="inner-wrap">


    <nav class="top-bar docs-bar hide-for-small" data-topbar>

        <div id="header">
            <h1><a href="index.html">烂笔头</a></h1>
        </div>

    </nav>


    <div class="row">
        <div class="sidebar">
            <ul id="side-nav" class="side-nav">

                
                <li class="side-title"><span>Android</span></li>
                
                <li><a title="Android登录页面，未勾选用户协议、隐私政策出现抖动效果" href="16280609822586.html">Android登录页面，未勾选用户协议、隐私政策出现抖动效果</a></li>
                
                <li><a title="DialogFragment内存泄露问题能不能一次性改好" href="16251021954820.html">DialogFragment内存泄露问题能不能一次性改好</a></li>
                
                <li><a title="Android静默安装实现方案，仿360手机助手秒装和智能安装功能" href="16251021954779.html">Android静默安装实现方案，仿360手机助手秒装和智能安装功能</a></li>
                
                <li><a title="Android 添加水印功能" href="16251021954737.html">Android 添加水印功能</a></li>
                
                <li><a title="Android 监听手电筒状态" href="16251021954689.html">Android 监听手电筒状态</a></li>
                 
                <li class="side-title"><span>Github</span></li>
                
                <li><a title="使用Github+jsdelivr构建你的免费图床" href="16251022060206.html">使用Github+jsdelivr构建你的免费图床</a></li>
                 
                <li class="side-title"><span>Glide</span></li>
                
                <li><a title="Glide源码修改-自定义磁盘缓存实现永久存储" href="16251022251608.html">Glide源码修改-自定义磁盘缓存实现永久存储</a></li>
                
                <li><a title="Android—Glide使用教程（一）" href="16251022251568.html">Android—Glide使用教程（一）</a></li>
                
                <li><a title="Android—Glide使用教程（二）" href="16251022251484.html">Android—Glide使用教程（二）</a></li>
                
                <li><a title="Android—Glide使用教程（三）" href="16251022251527.html">Android—Glide使用教程（三）</a></li>
                 
                <li class="side-title"><span>Gradle</span></li>
                
                <li><a title="Gradle 自定义Plugin插件之上传APK到蒲公英" href="16280610391708.html">Gradle 自定义Plugin插件之上传APK到蒲公英</a></li>
                
                <li><a title="自定义Gradle Plugin，优雅的解决第三方Jar包中的bug" href="16280610391664.html">自定义Gradle Plugin，优雅的解决第三方Jar包中的bug</a></li>
                
                <li><a title="如何使用Android Studio开发Gradle插件" href="16280610391616.html">如何使用Android Studio开发Gradle插件</a></li>
                
                <li><a title="sourceSets使用" href="16251022385733.html">sourceSets使用</a></li>
                
                <li><a title="脑洞大开，Gradle项目管理依赖的船新版本" href="16251022385689.html">脑洞大开，Gradle项目管理依赖的船新版本</a></li>
                 
                <li class="side-title"><span>Rxjava</span></li>
                
                <li><a title="RxJava2 只看这一篇文章就够了" href="16251022491138.html">RxJava2 只看这一篇文章就够了</a></li>
                 
                <li class="side-title"><span>GreenDAO</span></li>
                
                <li><a title="GreenDao 3.3.0 基本使用与入门 （一）" href="16280610693006.html">GreenDao 3.3.0 基本使用与入门 （一）</a></li>
                
                <li><a title="GreenDao 3.3.0 多表关联使用（二）" href="16280610765764.html">GreenDao 3.3.0 多表关联使用（二）</a></li>
                
                <li><a title="GreenDao 3.3.0 增删改查的使用（三）" href="16280610843145.html">GreenDao 3.3.0 增删改查的使用（三）</a></li>
                 
                <li class="side-title"><span>组件化</span></li>
                
                <li><a title="组件化架构之解决Common组件中心化问题(api化方案)" href="16280609309201.html">组件化架构之解决Common组件中心化问题(api化方案)</a></li>
                 
            </ul>
        </div>
        <div class="columns"> <div id="main-content" class="markdown-body">
    <h1>脑洞大开，Gradle项目管理依赖的船新版本</h1>

    <h1 id="toc_0">Gradle依赖管理最佳实践</h1>

<h2 id="toc_1">问题背景和必要知识</h2>

<p>首先确定一件事情：</p>

<pre><code class="language-gradle">implementation fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])
</code></pre>

<p>此类方式，引入的库包不属于 <code>仓库</code> 范畴，仅讨论基于Maven仓库的范畴，赘述一句，仓库按照习惯又可以分为两种类型：</p>

<ul>
<li>Local：特指Maven的MavenLocal仓库，或者Gradle的Cache，<em>MavenLocal和Gradle的Cache本质是一致</em></li>
<li>Remote：通过Uri指定的特定位置的仓库，最为常见的是MavenCentral和JCenter仓库。当然，可以将本机的目录指定为 &quot;远程仓库&quot; 位置。</li>
</ul>

<p><strong>当然，这并不影响本文的讨论</strong></p>

<hr/>

<p>众所周知，使用Gradle确定仓库的库包需要三个因素：</p>

<ul>
<li>GroupId</li>
<li>ArtifactId</li>
<li>version ，<em>&#39;+&#39;号通配符表达 <code>最新</code> 的含义</em></li>
</ul>

<p>for example：</p>

<pre><code class="language-gradle">androidx.core:core-ktx:1.3.2
</code></pre>

<ul>
<li>GroupId 为 &quot;androidx.core&quot;</li>
<li>ArtifactId 为 &quot;core-ktx&quot;</li>
<li>version 为 &quot;1.3.2&quot;</li>
</ul>

<hr/>

<h3 id="toc_2">问题背景</h3>

<p><strong>以Android为例</strong>，商业项目中，<code>一个Project仅存在一个Module</code> 的情况应该 <strong>非常少见</strong> 了， 往往一个Project下会存在多个Module，而且存在一定的依赖关系。</p>

<blockquote>
<p>如果没有合适的管理手段，那么每个Module均声明自身的依赖项，当发生版本变更时：</p>

<ul>
<li><code>修改过于零碎</code></li>
<li><code>同一个依赖项在不同Module下可能出现版本差异</code>，这也是上一点所带来的后果</li>
</ul>
</blockquote>

<p>举个更典型的例子，以 <strong>后端项目为例</strong>，<code>微服务</code> 的概念大家一定不陌生.</p>

<blockquote>
<p><em>即使未曾深入了解，也知道后端将整个服务体系进行了拆分，用多个子系统项目（微服务）共同</em> *支撑完整的服务体系。 以此达到 <strong>降低复杂度</strong>、 <strong>根据业务特性使用不同框架</strong>、 <strong>根据业务权重定制运维策略</strong> 等目的*</p>
</blockquote>

<p>而微服务之间通过RPC进行通信，而此处势必牵涉一个最大的 <code>痛点</code> ：<code>Service方法签名和DTO数据保持一致</code>，否则会带来 <code>方法不存在</code> 或者 <code>数据遗失、解析错误</code> 等问题。</p>

<h2 id="toc_3">传统做法及其优劣</h2>

<p>比较早期的做法，是在Gradle构建时的运行环境中，创建或者利用Project级别的集合对象，将依赖项信息全部写入其中，各个Module使用时，达成了统一。</p>

<p><em>大家对这种做法很熟悉，不再用代码举例。</em> 往往需要用到Extension扩展，为了方便描述，我们将：<code>存储依赖项信息的Project级别集合</code> 称为 <code>Ext.deps</code></p>

<p><strong>优点</strong>：</p>

<ul>
<li>统一管理入口。一次修改，全Project生效</li>
</ul>

<p><strong>缺点</strong>：</p>

<ul>
<li>无法进行代码提示</li>
<li>一般无法兼容于构建工具的 <code>新版本提示</code></li>
<li>仅针对单Project，无法应对多Project，<em>后端的微服务往往是多Project</em></li>
</ul>

<h3 id="toc_4">改良版</h3>

<p>利用Gradle 可以apply 远程构建脚本 <em>(xxx.gradle)</em> 的特性，进行方案改进。</p>

<p>将 &quot;构建 Ext.deps 信息&quot; 的 <code>脚本</code>，存储于网络特定位置，以解决多Project难以管理的问题。</p>

<p><strong>一般需要对脚本文件按照版本命名，并保有所有版本的脚本。</strong></p>

<p>这样可以避免：项目回溯版本功能时，出现额外问题。</p>

<h2 id="toc_5">利用Gradle留的后门</h2>

<p>Gradle编译项目是很有意思的事情，我们知道：在成功加载完Gradle项目后，会 <code>编译Gradle脚本</code>并生成各类Gradle任务，<em>实际情况会更加复杂</em>，为了方便，我们将之称为 <code>Task编译</code></p>

<p>既然存在编译过程，Gradle团队索性留了一个后门：</p>

<blockquote>
<p>如果根项目下存在&quot;buildSrc&quot;, gradle 认为这是在Task编译过程中需要编译的内容，这些内容可能包含了：</p>

<ul>
<li>Gradle插件内容</li>
<li>插件设置内容</li>
<li>等等</li>
</ul>

<p>并且其编译结果对于该项目下的Gradle内容<strong>透明</strong></p>
</blockquote>

<p><em>这并不是一个新的特性，它至少已经有五年的历史了</em></p>

<p><a href="https://docs.gradle.org/current/userguide/organizing_gradle_projects.html">Gradle官方指导文档</a> ，官方文档对其使用方式做了概要的描述。</p>

<h3 id="toc_6">勘误</h3>

<p>因为buildSrc机制已经不是一个新特性了，故而利用这个机制去 <code>管理Gradle依赖信息</code> 已经是一个老话题了。</p>

<p>可能是<code>巧合</code>，该做法出现在开发者视野中时，刚好是 gradle开始对 <code>kotlin-dsl</code> 进行支持，<em>同样不是新特性，大约是三年前的Gradle-4.10</em>。</p>

<p>而开始流行的做法又恰好对新特性进行了尝鲜，并且在讲解视频中留下了一些坑，于是这一做法的着重点，便被吸引到了 <code>如何正确使用kotlin管理Gradle项目的依赖项</code>这一话题上。</p>

<blockquote>
<p>这一做法和kotlin、kts脚本并无实质关联</p>
</blockquote>

<h3 id="toc_7">做法</h3>

<p>在buildSrc目录下，按照标准sourceSet结构建立目录，并新增类文件例如：</p>

<pre><code class="language-java">buildSrc/src/main/java/Deps.java

public class Deps {
    public static String junit = &quot;junit:junit:4.13.0&quot;;
}
</code></pre>

<p>sync后，类会被编译，我们可以在项目下的Gradle脚本中，只用使用，例如：</p>

<pre><code class="language-groovy">dependencies {
    //...
    
    testImplementation Deps.junit
//    &#39;junit:junit:4.+&#39;
    androidTestImplementation &#39;androidx.test.ext:junit:1.1.2&#39;
    androidTestImplementation &#39;androidx.test.espresso:espresso-core:3.3.0&#39;
}
</code></pre>

<p>并且可以享有 <code>代码提示</code> 、 <code>跳转</code> 、 <code>javaDoc弹窗</code> 功能</p>

<hr/>

<p>而可查询到的常见做法，往往是使用kotlin类，那么就需要让buildSrc <code>在编译时支持kotlin</code> ，那么自然需要 <code>添加插件</code> ：</p>

<p>在buildSrc下新建 <code>build.gradle</code> 并添加插件：</p>

<pre><code class="language-groovy">apply plugin: &quot;kotlin&quot;

buildscript {
    ext.kotlin_version = &quot;1.4.21&quot;
    repositories {
        jcenter()
    }
    dependencies {
        classpath &quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;
    }
}
repositories {
    jcenter()
}
</code></pre>

<p>即可，此时添加的kotlin类即可被编译。</p>

<pre><code class="language-kotlin">buildSrc/src/main/java/KDeps.kt

object KDeps {
    @JvmStatic
    val ext_junit = &quot;androidx.test.ext:junit:1.1.2&quot;
}
</code></pre>

<p>使用示例：</p>

<pre><code class="language-groovy">dependencies {
    testImplementation Deps.junit
//    &#39;junit:junit:4.+&#39;
    androidTestImplementation KDeps.ext_junit
    //&#39;androidx.test.ext:junit:1.1.2&#39;
    androidTestImplementation &#39;androidx.test.espresso:espresso-core:3.3.0&#39;
}
</code></pre>

<p>同样可以享有 <code>代码提示</code> 、 <code>跳转</code> 、 <code>javaDoc弹窗</code> 功能</p>

<p>而网传的 <code>kts脚本</code> 以及添加 <code>kotlin-dsl</code>支持，其实在这个需求中，并无真正的有效用途，只不过是应用了kts脚本后， 本身就需要编译kotlin内容，所以 <code>默认使用了kotlin编译插件</code></p>

<hr/>

<p>言归正传，使用这种管理方式后，我们解决了无代码提示的弊端，再次 <code>利用机器解放生产力</code>。</p>

<p>但是，我们没有解决服务端例子中的问题</p>

<h3 id="toc_8">将依赖信息打包发布</h3>

<p>我想你已经深刻意识到了buildSrc机制的本质是啥：</p>

<blockquote>
<p>利用Gradle 编译 buildSrc内容，产物供 <code>后续的</code> <code>该项目的</code> <code>Gradle编译过程</code> 使用</p>
</blockquote>

<p>那么你一定可以想到，buildSrc可以申明自身的依赖！</p>

<p>于是，我们对常用库包进行分析后，选取对象并确定版本后，即可编写一个Library，</p>

<ul>
<li>将库包信息写成常量</li>
<li>对Library建立版本机制</li>
<li>发布Library并在buildSrc中使用</li>
</ul>

<p>这是最简单的做法，即可在多个Project下，以最小的人力成本管理依赖并满足 <code>一致性需求</code></p>

<h3 id="toc_9">进阶</h3>

<p>Library依赖 Gradle后，可以编写 Gradle-Task内容配置 的过程代码，封装 <code>依赖添加</code> 和 <code>依赖检查</code> 等内容。</p>

<p>举个简单的例子：</p>

<pre><code class="language-kotlin">object KDeps {
    //    @JvmStatic
    const val ext_junit = &quot;androidx.test.ext:junit:1.1.2&quot;
}

public class Deps {
    public static String junit = &quot;junit:junit:4.13.0&quot;;

    public static void applyAll(Project project) {
        project.getDependencies().add(
                &quot;testImplementation&quot;, junit
        );
        project.getDependencies().add(
                &quot;androidTestImplementation&quot;,KDeps.ext_junit
        );
    }
}
</code></pre>

<p>buildSrc/build.gradle</p>

<pre><code class="language-groovy">apply plugin: &quot;kotlin&quot;

buildscript {
    ext.kotlin_version = &quot;1.4.21&quot;
    repositories {
        jcenter()
    }
    dependencies {
        classpath &quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;
//        implementation &#39;com.android.tools.build:gradle:4.1.1&#39;
        //gradle sdk
        gradleApi()
    }
}
repositories {
    jcenter()
}
</code></pre>

<p>在app 的build.gradle中，可以这样使用：</p>

<pre><code class="language-groovy">plugins {
    id &#39;com.android.application&#39;
    id &#39;kotlin-android&#39;
}

android {
    //略
}

dependencies {
    //略
    
    //修改为直接在 afterEvaluate 后调用函数设置
//    testImplementation Deps.junit
//    androidTestImplementation KDeps.ext_junit
    androidTestImplementation &#39;androidx.test.espresso:espresso-core:3.3.0&#39;
}

afterEvaluate {
    Deps.applyAll(project)
}
复制代码
</code></pre>

<p>当然，我们在这个过程中还可以使用各类编程技巧。</p>

<p>此时，我们已经拥有了无限可能，<code>根据项目的实际需求</code> ，自行拓展吧。</p>


</div>

<br /><br />
<hr />

<div class="content-nav">
    <div class="large-6 columns">
        <div class="text-left" style="padding:15px 0px;">
            
            <a href="16251022385733.html" title="Previous Post: sourceSets使用">&laquo; sourceSets使用</a> 
        </div>
    </div>
    <div class="large-6 columns">
        <div class="text-right" style="padding:15px 0px;">
            
            <a href="16251022060206.html" title="Next Post: 使用Github+jsdelivr构建你的免费图床">使用Github+jsdelivr构建你的免费图床 &raquo;</a> 
        </div>
    </div>
</div>

<div class="content_share">
    <div style="padding:0px 0.93em;" class="share-comments">
        
    </div>
</div>
<script type="text/javascript">
    $(function() {
        var currentURL = '16251022385689.html';
        $('#side-nav a').each(function() {
            if ($(this).attr('href') == currentURL) {
                $(this).parent().addClass('active');
            }
        });
    });
</script>  </div>
</div>


<div class="page-bottom">
    <div class="copyright">
        <a href="mailto:888api@sina.com">郝彬彬</a> &copy; 
    </div>
    <div class="copyright text-right">
        <a href="#main-content">TOP</a>
    </div>
</div>

</div>




  














<style type="text/css">
    figure {
        margin: 0.4em 0;
        padding: 0;
    }
    
    figcaption {
        text-align: center;
    }
    /* PrismJS 1.14.0
 http://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript */
    /**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */
    
    code[class*="language-"],
    pre[class*="language-"] {
        color: black;
        background: none;
        text-shadow: 0 1px white;
        font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        line-height: 1.5;
        -moz-tab-size: 4;
        -o-tab-size: 4;
        tab-size: 4;
        -webkit-hyphens: none;
        -moz-hyphens: none;
        -ms-hyphens: none;
        hyphens: none;
    }
    
    pre[class*="language-"]::-moz-selection,
    pre[class*="language-"] ::-moz-selection,
    code[class*="language-"]::-moz-selection,
    code[class*="language-"] ::-moz-selection {
        text-shadow: none;
        background: #b3d4fc;
    }
    
    pre[class*="language-"]::selection,
    pre[class*="language-"] ::selection,
    code[class*="language-"]::selection,
    code[class*="language-"] ::selection {
        text-shadow: none;
        background: #b3d4fc;
    }
    
    @media print {
        code[class*="language-"],
        pre[class*="language-"] {
            text-shadow: none;
        }
    }
    /* Code blocks */
    
    pre[class*="language-"] {
        padding: 1em;
        margin: .5em 0;
        overflow: auto;
    }
    
     :not(pre)>code[class*="language-"],
    pre[class*="language-"] {
        background: #F7F7F7;
    }
    /* Inline code */
    
     :not(pre)>code[class*="language-"] {
        padding: .1em;
        border-radius: .3em;
        white-space: normal;
    }
    
    .token.comment,
    .token.prolog,
    .token.doctype,
    .token.cdata {
        color: slategray;
    }
    
    .token.punctuation {
        color: #999;
    }
    
    .namespace {
        opacity: .7;
    }
    
    .token.property,
    .token.tag,
    .token.boolean,
    .token.number,
    .token.constant,
    .token.symbol,
    .token.deleted {
        color: #905;
    }
    
    .token.selector,
    .token.attr-name,
    .token.string,
    .token.char,
    .token.builtin,
    .token.inserted {
        color: #690;
    }
    
    .token.operator,
    .token.entity,
    .token.url,
    .language-css .token.string,
    .style .token.string {
        color: #9a6e3a;
        background: hsla(0, 0%, 100%, .5);
    }
    
    .token.atrule,
    .token.attr-value,
    .token.keyword {
        color: #07a;
    }
    
    .token.function,
    .token.class-name {
        color: #DD4A68;
    }
    
    .token.regex,
    .token.important,
    .token.variable {
        color: #e90;
    }
    
    .token.important,
    .token.bold {
        font-weight: bold;
    }
    
    .token.italic {
        font-style: italic;
    }
    
    .token.entity {
        cursor: help;
    }
    
    pre[class*="language-"].line-numbers {
        position: relative;
        padding-left: 3.8em;
        counter-reset: linenumber;
    }
    
    pre[class*="language-"].line-numbers>code {
        position: relative;
        white-space: inherit;
    }
    
    .line-numbers .line-numbers-rows {
        position: absolute;
        pointer-events: none;
        top: 0;
        font-size: 100%;
        left: -3.8em;
        width: 3em;
        /* works for line-numbers below 1000 lines */
        letter-spacing: -1px;
        border-right: 1px solid #999;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    .line-numbers-rows>span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
    }
    
    .line-numbers-rows>span:before {
        content: counter(linenumber);
        color: #999;
        display: block;
        padding-right: 0.8em;
        text-align: right;
    }
</style>

<script src="asset/js/foundation.min.js"></script>
<script src="asset/js/foundation/foundation.offcanvas.js"></script>
<script>
    $(document).foundation();
</script>
<script src="asset/js/watermark.js"></script>

</body>

</html>